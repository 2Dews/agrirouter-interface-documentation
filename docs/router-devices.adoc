= Router Devices
:imagesdir: ./../assets/images/
:toc:
:toc-title:
:toclevels: 4

== General function
Without router devices, an application would need to create multiple MQTT connections, which might cost quite a lot of resources. Therefore, router devices were implemented to allow routing multiple connections using one MQTT broker.

When using MQTT for a telemetry platform or a farming software with multiple accounts, multiple MQTT connections to different brokers would be required. To avoid this, agrirouter introduced the **router devices** which allow routing multiple connections for virtual endpoints.


++++
<p align="center">
 <img src="./../assets/images/general/router-devices2.png"><br>
 <i>Using Router devices vs. not using router devices</i>
</p>
++++

++++
<p align="center">
 <img src="./../assets/images/general/router-devices1.png"><br>
 <i>Using router devices vs. communication using communication units</i>
</p>
++++

== Setup of router devices
Router devices can be set up and managed in the agrirouter developer UI
++++
<p align="center">
 <img src="./../assets/images/general/router-devices-screen1.png"><br>
 <i>Router device management in the agrirouter developer UI</i>
</p>
++++

When clicking on "New Router device", a new device will be generated.
++++
<p align="center">
 <img src="./../assets/images/general/router-devices-screen2.png"><br>
 <i>Router device management in the agrirouter developers UI</i>
</p>
++++

To check the connection properties, click on "Connection Details".
++++
<p align="center">
 <img src="./../assets/images/general/router-devices-screen3.png"><br>
 <i>Router device details</i>
</p>
++++

The certificate for the router device can be downloaded as PEM or P12.
++++
<p align="center">
 <img src="./../assets/images/general/router-devices-screen4.png"><br>
 <i>Download certificate of router device</i>
</p>
++++

The file includes a JSON structure containing all necessary information for the router device
[source,javascript]
----
{
    "authentication": {
        "type": "PEM",
        "secret": "s7jRq5jEvru914M3INJ6B0SluVYKHRmradqo",
        "certificate": "-----BEGIN ENCRYPTED PRIVATE KEY-----\n...\n-----END CERTIFICATE-----\n"
    },
    "deviceAlternateId": "d410a40c-920a-4af5-b4f8-80e45d2904f8",
    "connectionCriteria": {
        "clientId": "27b5ca3e-eb96-4b38-b586-61f9c6a724c4",
        "gatewayId": "2",
        "host": "dke-qa.eu10.cp.iot.sap",
        "port": 8883
    }
}
----

`ConnectionCriteria` and `Authentication` of a single endpoint can be replaced by the data given from the router device, so that every software component of a specific manufacturer can communicate using one router device, as long as all the application instance is connected to the same server. There cannot exist multiple connections using the same router device.

[WARNING]
====
For a proper connection, you need to use the `deviceAlternateId` as `clientId`, *not* the `connectionCriteria.clientId`!
====

[WARNING]
====
Every time the certificate is downloaded, it is updated in the agrirouter backend. Make sure you store the certificate in a secure place after you downloaded it and only click the download button again if you want to update your certificate (see below).
====

=== Certificate update

As well as the certificates received after onboarding an endpoint, the certificates of the router device have a limited validity period of 1 year as well.
To make sure, that the communication is not blocked after 1 year, the certificate needs to be updated.
To update a certificate, the developer has to upen the details of the certificate view and click on download.
