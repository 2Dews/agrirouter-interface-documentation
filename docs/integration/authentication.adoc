= Authentication Process
:imagesdir: ./../../assets/images/
*Table of Content*
:toc:
:toc-title:
:toclevels: 4


== What is this process used for?

The authentication process was designed to give application providers of consuming applications (e.g. farming software, but in general every application that consumes data) the chance to make sure, they know, which account is assigned to which agrirouter account. Otherwise, fake accounts could consume data on their costs.

[NOTE]
==== 
As the authentication process – in difference to the rest of the communication – provides a request to your agrirouter integration and not the response to a request from your agrirouter integration, the documentation of the parameters is done in a little different way and there is no description for a HTTP Response code, because we don’t get one.
====

== Authentication of farming software

As application providers of farming software have to pay for the receiving of raw data, the application provider should make sure, that only such agrirouter accounts can onboard one of his applications, that he can assign to one of his users.

[NOTE]
====
As the user has to log on to agrirouter, the authentication process requires a browser UI!
====

=== Preparation

To provide authentication, the developer first has to setup the application.

In the developers UI, he has to:

* Copy the application ID (1)
* Call Edit (2)
* Provide a redirect URL, to which agrirouter shall deliver the authentication result using HTTP 301 Browser redirect.(3)
* Provide a public key for his encryption or create a key pair on the agrirouter frontend

image:ig2/image10.PNG[image,width=636,height=361,align="center"]

Figure 5 Application overview

image:ig2/image11.PNG[image,width=362,height=350,align="center"]

Figure 6 Application settings

[NOTE]
====
If you do not yet have an official domain, where your application is reachable online, you can use http://fuf.me. This URL is a synonym for localhost or 127.0.0.1, but it meets the requirements of the agrirouter UI for redirect URLs.

Simply check Tracert/TraceRoute:

image:ig2/image12.png[image,width=466,height=181,align="center"]

Figure 7 fuf.me is an alias for localhost
====

=== Authentication Process Overview

The authentication process works as follows:

image:ig2/image13.png[image,width=619,height=376,align="center"]

Figure 8 Authentication Workflow

To better understand, what happens here, try the following:

1.  Call https://httpbin.org/get in your browser. You’ll get a JSON view of the get request
2.  Call https://httpbin.org/get?Param1=Value1&Param2=Value2 in your browser. You’ll get a view of the get request

* https://httpbin.org simply echoes the request that is send to the page. That’s important to understand

[NOTE]
====
* For testing purpose, you can just enter the url https://httpbin.org/get in your applications redirect URL (see below) to see the result of authentication.

* The step “user clicks on Link” might not be needed, applications could handle that different.
====

For example the application could send a redirect (HTTP Status 300) to directly redirect the user to the agrirouter Connection Website. The description “user clicks on Link” is simply the most understandable description we could come up with.

=== Generating an authentication URL

[cols="1,2,4",options="header",]
|===========================================================================
|Area |Environment |URL
|EU1 |Quality Assurance |https://agrirouter-qa.cfapps.eu1.hana.ondemand.com/
|EU1 |Productive |https://goto.my-agrirouter.com/
|===========================================================================

The authentication Link is a HTTP GET Request that has to be called from a browser.

[cols="1,4",options="header",]
|===============================================
|Method |Address
|GET |/application/\{\{applicationID}}/authorize
|===============================================

To provide a link for authentication, create a link like this:

__*\{\{agrirouter-url}}/application/\{\{applicationID}}/authorize?\{\{response_type}}&\{\{state}}&\{\{redirectURL}}*__

[cols="2,3,3",options="header",]
|=====================================================================================
|Parameter |Example Value |Remark
|\{\{agrirouter-url}} |see above |Differentiates between QA and Live system
|\{\{applicationID}} |Noted from the agrirouter UI |
|\{\{response_type}} |response_type=onboard a|
Possible values:

verify: only verify the user,

onboard: verify user and create a Registration Code (Token)

|\{\{state}} |state=w4st556dr543d4wr4s4 a|
A number to identify the request result on server side. The provided Number should be:

* Unique
* Not guessable

|\{\{redirect_uri}} | |Could extend your entered redirect URL
|=====================================================================================

[CAUTION]
====
Calling this link will deliver a website to log in to agrirouter, therefore, this link has to be called through a browser!
====

[NOTE]
====
The response type onboard can be used to onboard farming applications without having to create a Registration Code in the agrirouter UI.
====

=== Perform authentication

When the user clicks on the link, the agrirouter website is called. If the user is currently not logged in, he has to log in. After logging in, he is delivered a website to authorize the connection between agrirouter and the application provider:

image:ig2/image14.png[image,width=252,height=202,align="center"]

Figure 9 Application authentication screen

=== Analyse result

agrirouter sends an HTTP 301 redirect to the browser, encoding the authentication result in a GET queue attached to the Redirect URL entered in the developers’ application settings.

The browser reacts in requesting this redirect URL which performs a GET request at the endpoint of the address.

The following parameters will be delivered in the GET-Queue:

[cols="1,2,2,4",options="header",]
|============================================================================================================
|Position |Name |Type |Description
|1 |signature |String |A base64 encoded signature to verify, that the source of the message is the agrirouter
|2 |state |String |The value that was passed to the agrirouter in parameter State
|3 |token |String |A base64 encoded JSON Object as Result
|(3) |error |String |If error is delivered, user declined connection!
|============================================================================================================

image:ig2/image15.png[image,width=542,height=265,align="center"]

Figure 10 Example of an authentication result

==== Checking for errors

If the result includes a parameter *error*, the request was declined. Possible values:

[cols=",",options="header",]
|===============================================
|Value |Description
|request_declined |The user clicked on “decline”
|===============================================

==== Checking authenticity

Before analyzing the result, which is encoded in the *token*, it should be made sure, that the result (provided to the browser and from there to the application providers server) is really provided by the agrirouter.

Steps:

 * concatenate _*state*_ and _*token*_ from the query
 * create the SHA256 hash of the concatenated string
 * verify the authenticity of the _*signature*_ with the agrirouter public key and generated hash

[NOTE]
====
* Many implementations of the Verification algorithm directly include the SHA256 hashing. If you have to provide the algorithm SHA256 to your verification library call, it’s fairly possible, that you do NOT have to create a SHA256 hash before and can directly provide the concated Strings of state and token.

* The public keys can be found at Certificates and keys
====

==== Analyse the result in token

The result token is a base64 encoded JSON object including the following parameters:

[cols="1,1,3",options="header",]
|=======================================================================================================================================================
|Name |Type |Description
|account |String |The unique id of the user account on agrirouter , that will be provided to you in the metrics exports for billing
|regcode |String |If response-type=onboard, this regcode will deliver a Registration Code equal to clicking the generate TAN-Button in the agrirouter ui
|expires |DataTime |The date and time (in UTC), when the regcode becomes invalid
|=======================================================================================================================================================

//TODO: Example Template
[source,JavaScript]
====
{

"account": "31c83d5d-c307-42f9-80b1-6fc9324823b8", +
"regcode": "f75bfbd41b",

"expires": "2018-02-27T10:49:04.901Z"

}
====

== Authentication for CUs and non-cloud-software

To perform authentication for software, that is not provided as a cloud solution, a small cloud onboarding service could be created to handle the onboarding communication:

image:ig2/image16.png[image,width=640,height=155,align="center"]

Figure 11 Authentication for non-cloud-applications